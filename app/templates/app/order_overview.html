{% extends "app/base.html" %}
{% load static extra_tags mathfilters %}

{% block content %}
<section class="bg-gray-100 min-h-screen py-8 antialiased dark:bg-gray-900 md:py-16">
    <form id="orderForm" class="mx-auto max-w-screen-xl px-4 2xl:px-0">
        <h1 class="text-xl font-semibold text-gray-900 dark:text-white sm:text-2xl">{{ order.pharmacy.name }}</h1>
        <div class="flex flex-row mb-3">
            <p class="text-lg font-medium text-gray-900 dark:text-white">{{ order.pharmacy.street }} {{ order.pharmacy.street_number }}, {{ order.pharmacy.postalcode }} {{ order.pharmacy.city }}</p>
        </div>
        <h2 class="text-xl font-semibold text-gray-900 dark:text-white sm:text-2xl">Bestellübersicht</h2>

        <div class="mt-8 space-y-6 md:space-y-8">
            <div class="grid grid-cols-1 gap-6 md:gap-8 lg:grid-cols-3">
                <div class="relative space-y-4 rounded-lg border border-gray-200 bg-white p-6 shadow-sm dark:border-gray-700 dark:bg-gray-800">
                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white">Rechnungsadresse</h4>

                    <dl class="pb-9">
                        <dt class="text-base font-medium text-gray-900 dark:text-white"><span class="first_name">{{ order.first_name }}</span> <span class="last_name">{{ order.last_name }}</span></dt>
                        <dd class="mt-1 text-base font-normal text-gray-500 dark:text-gray-400"><span class="street">{{ order.street }}</span> <span class="street_number">{{ order.street_number }}</span></dd>
                        <dd class="mt-0 text-base font-normal text-gray-500 dark:text-gray-400"><span class="postalcode">{{ order.postalcode }}</span> <span class="city">{{ order.city }}</span></dd>
                        <dd class="mt-0 text-base font-normal text-gray-500 dark:text-gray-400"><span class="phone_number">{{ order.phone_number }}</span></dd>
                        <dd class="mt-0 text-base font-normal text-gray-500 dark:text-gray-400"><span class="email_address">{{ order.email_address }}</span></dd>
                        <dd class="mt-0 text-base font-normal text-gray-500 dark:text-gray-400"><span class="country">{{ order.get_country_display }}</span></dd>
                    </dl>

                    <button type="button" data-modal-target="billingInformationModal"
                        class="text-base mr-auto font-medium text-primary-700 hover:underline dark:text-primary-500 absolute bottom-6 left-6 flex"
                        onclick="openBillingInformationModal()">
                        <svg class="w-5 h-5 me-1 text-gray-800 dark:text-white my-auto" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m14.304 4.844 2.852 2.852M7 7H4a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h11a1 1 0 0 0 1-1v-4.5m2.409-9.91a2.017 2.017 0 0 1 0 2.853l-6.844 6.844L8 14l.713-3.565 6.844-6.844a2.015 2.015 0 0 1 2.852 0Z"/>
                        </svg>
                        Bearbeiten
                    </button>
                </div>

                <div class="relative space-y-4 rounded-lg border border-gray-200 bg-white p-6 shadow-sm dark:border-gray-700 dark:bg-gray-800">
                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white">Lieferadresse</h4>

                    <dl class="pb-9">
                        <dt class="text-base font-medium text-gray-900 dark:text-white"><span class="delivery_type">{{ order.get_delivery_type_display }}</span></dt>
                        <dd class="mt-1 text-base font-normal text-gray-500 dark:text-gray-400"><span class="delivery_first_name">{{ order.del_first_name }}</span> <span class="delivery_last_name">{{ order.del_last_name }}</span></dd>
                        <dd class="mt-0 text-base font-normal text-gray-500 dark:text-gray-400"><span class="delivery_street">{{ order.del_street }}</span> <span class="delivery_street_number">{{ order.del_street_number }}</span></dd>
                        <dd class="mt-0 text-base font-normal text-gray-500 dark:text-gray-400"><span class="delivery_postalcode">{{ order.del_postalcode }}</span> <span class="delivery_city">{{ order.del_city }}</span></dd>
                    </dl>

                    <button type="button" data-modal-target="deliveryInformationModal"
                        onclick="openDeliveryInformationModal()"
                        class="text-base font-medium text-primary-700 hover:underline dark:text-primary-500 absolute bottom-6 left-6 flex">
                        <svg class="w-5 h-5 me-1 text-gray-800 dark:text-white my-auto" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m14.304 4.844 2.852 2.852M7 7H4a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h11a1 1 0 0 0 1-1v-4.5m2.409-9.91a2.017 2.017 0 0 1 0 2.853l-6.844 6.844L8 14l.713-3.565 6.844-6.844a2.015 2.015 0 0 1 2.852 0Z"/>
                        </svg>
                        Bearbeiten
                    </button>
                </div>

                <div
                    class="relative space-y-4 rounded-lg border border-gray-200 bg-white p-6 shadow-sm dark:border-gray-700 dark:bg-gray-800">
                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white">Zahlungsmethode</h4>

                    <dl class="pb-9">
                        <dt class="text-base font-medium text-gray-900 dark:text-white payment_type">{{ order.get_payment_type_display }}</dt>
                    </dl>

                    <button type="button" data-modal-target="paymentInformationModal"
                        onclick="openPaymentInformationModal()"
                        class="text-base font-medium text-primary-700 hover:underline dark:text-primary-500 mt-auto absolute bottom-6 left-6 flex">
                        <svg class="w-5 h-5 me-1 text-gray-800 dark:text-white my-auto" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m14.304 4.844 2.852 2.852M7 7H4a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h11a1 1 0 0 0 1-1v-4.5m2.409-9.91a2.017 2.017 0 0 1 0 2.853l-6.844 6.844L8 14l.713-3.565 6.844-6.844a2.015 2.015 0 0 1 2.852 0Z"/>
                        </svg>
                        Bearbeiten
                    </button>
                </div>
            </div>

            <div
                class="divide-y divide-gray-200 rounded-lg border border-gray-200 bg-white shadow-sm dark:divide-gray-700 dark:border-gray-700 dark:bg-gray-800">
                
                <!-- Header -->
                <div class="flex flex-wrap items-center space-y-4 p-6 sm:gap-6 sm:space-y-0 md:justify-between bg-gray-800 rounded-t-lg">
                    <div class="w-full items-center space-y-4 sm:flex sm:space-x-6 sm:space-y-0 md:max-w-md lg:max-w-lg">

                        <div class="w-full md:max-w-sm lg:max-w-md">
                            <p class="font-medium text-white hover:underline dark:text-white">Bezeichniung</p>
                        </div>
                    </div>

                    <div class="w-20 shrink-0">
                        <p class="text-base text-left text-md-right font-normal text-white dark:text-white">Einzelpreis</p>
                    </div>

                    <div class="w-14 shrink-0">
                        <p class="text-base text-right font-normal text-white dark:text-white">Menge</p>
                    </div>

                    <div class="ms-auto md:ms-0 md:w-24 md:text-right">
                        <p class="text-base font-bold text-white dark:text-white">Summe</p>
                    </div>
                </div>

                {% for order_product in order|get_order_products %}
                <div class="flex flex-wrap items-center space-y-4 p-6 sm:gap-6 sm:space-y-0 md:justify-between">
                    <div class="w-full items-center space-y-4 sm:flex sm:space-x-6 sm:space-y-0 md:max-w-md lg:max-w-lg">

                        <div class="w-full md:max-w-sm lg:max-w-md">
                            <p class="font-medium text-gray-900 hover:underline dark:text-white">{{ order_product.product.name }}</p>
                        </div>
                    </div>

                    <div class="w-20 shrink-0">
                        <p class="text-base text-left text-md-right font-normal text-gray-900 dark:text-white">{{ order_product.price|to_euro_decimal }} €</p>
                    </div>

                    <div class="w-14 shrink-0">
                        <p class="text-base text-right font-normal text-gray-900 dark:text-white">{{ order_product.amount }} {% if order_product.product.form == "flower" %}g{% else %}Einh.{% endif %}</p>
                    </div>

                    <div class="ms-auto md:ms-0 md:w-24 md:text-right">
                        <p class="text-base font-bold text-gray-900 dark:text-white">{{ order_product.total|to_euro_decimal }} €</p>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div
                class="space-y-4 rounded-lg border border-gray-200 bg-white p-6 shadow-sm dark:border-gray-700 dark:bg-gray-800">
                <div class="space-y-2">
                    <dl class="flex items-center justify-between gap-4">
                        <dt class="text-gray-500 dark:text-gray-400">Netto</dt>
                        <dd class="text-base font-medium text-gray-900 dark:text-white">{{ order.subtotal|to_euro_decimal }} €</dd>
                    </dl>

                    <dl class="flex items-center justify-between gap-4">
                        <dt class="text-gray-500 dark:text-gray-400">USt. 19%</dt>
                        <dd class="text-base font-medium text-gray-900 dark:text-white">{{ order.tax_amount|to_euro_decimal }} €</dd>
                    </dl>

                    <dl class="flex items-center justify-between gap-4">
                        <dt class="text-gray-500 dark:text-gray-400">Versandkosten</dt>
                        <dd class="text-base font-medium text-gray-900 dark:text-white">{{ order.delivery_costs|to_euro_decimal }} €</dd>
                    </dl>
                </div>

                <dl class="flex items-center justify-between gap-4 border-t border-gray-200 pt-2 dark:border-gray-700">
                    <dt class="text-lg font-bold text-gray-900 dark:text-white">SUMME</dt>
                    <dd class="text-lg font-bold text-gray-900 dark:text-white">{{ order.amount_payable|to_euro_decimal }} €</dd>
                </dl>
            </div>

            <div class="flex items-start sm:items-center">
                <input id="terms-checkbox" type="checkbox" value=""
                    class="cursor-pointer h-4 w-4 rounded border-gray-300 bg-gray-100 text-primary-600 focus:ring-2 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:ring-offset-gray-800 dark:focus:ring-primary-600" />
                <label for="terms-checkbox" class="cursor-pointer ms-2 text-sm font-medium text-gray-900 dark:text-gray-300">Hiermit stimme ich zu, dass <span class="font-bold">{{ order.pharmacy.name }}</span> mein Rezept und damit verbundenen Kundendaten verarbeiten darf</label>
            </div>

            <div class="flex items-start sm:items-center hidden" id="terms-checkbox-alert">
                <div class="px-3 py-2 mb-1 text-sm text-red-800 rounded-lg bg-red-50 dark:bg-gray-800 dark:text-red-400" role="alert">
                    <span class="font-medium">Bitte bestätigen Sie die Verarbeitung Ihrer Daten</span>
                </div>
            </div>


            <div class="gap-4 sm:flex sm:items-center">
                <button type="button" onclick="toggleModal('deleteOrderModal')" class="w-full rounded-lg  border border-gray-200 bg-white px-5 py-2.5 text-sm font-medium text-gray-900 hover:bg-gray-100 hover:text-primary-700 focus:z-10 focus:outline-none focus:ring-4 focus:ring-gray-100 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white dark:focus:ring-gray-700 sm:w-auto">
                    Bestellung ablehnen
                </button>
                <button type="button" onclick="saveOrder()" class="mt-4 flex w-full items-center justify-center rounded-lg bg-green-600 px-5 py-2.5 text-sm font-medium text-white hover:bg-green-800 focus:outline-none focus:ring-4 focus:ring-primary-300 dark:bg-primary-600 dark:hover:bg-primary-700 dark:focus:ring-primary-800 sm:mt-0 sm:w-auto">
                    Abschließen
                </button>
            </div>
        </div>
    </form>
</section>

<div id="billingInformationModal" tabindex="-1" aria-hidden="true"
    class="antialiased fixed left-0 right-0 top-0 z-50 hidden h-[calc(100%-1rem)] max-h-full w-full items-center justify-center overflow-y-auto overflow-x-hidden antialiased md:inset-0">
    <div class="relative max-h-full w-full max-w-lg p-4">
        <!-- Modal content -->
        <div class="relative rounded-lg bg-white shadow dark:bg-gray-800">
            <!-- Modal header -->
            <div
                class="flex items-center justify-between rounded-t border-b border-gray-200 p-4 dark:border-gray-700 md:p-5">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Rechnungsadresse</h3>
            </div>
            <!-- Modal body -->
            <form class="p-4 md:p-5" id="invoiceForm">
                {% csrf_token %}
                <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 mb-5">

                    <div>
                        <label for="first_name_billing_modal" class="mb-2 block text-sm font-medium text-gray-900 dark:text-white">Vorname*</label>
                        <input type="text" id="first_name_billing_modal" name="firstName"
                            class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-primary-500 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder:text-gray-400 dark:focus:border-primary-500 dark:focus:ring-primary-500"
                            placeholder="Vorname" required />
                    </div>

                    <div>
                        <label for="last_name_billing_modal" class="mb-2 block text-sm font-medium text-gray-900 dark:text-white">Nachname*</label>
                        <input type="text" id="last_name_billing_modal" name="lastName"
                            class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-primary-500 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder:text-gray-400 dark:focus:border-primary-500 dark:focus:ring-primary-500"
                            placeholder="Nachname" required />
                    </div>

                    <div>
                        <label for="email_billing_modal" class="mb-2 block text-sm font-medium text-gray-900 dark:text-white">E-Mail*</label>
                        <input type="text" id="email_billing_modal" name="email"
                            class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-primary-500 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder:text-gray-400 dark:focus:border-primary-500 dark:focus:ring-primary-500"
                            placeholder="max@example.de" required />
                    </div>

                    <div>
                        <label for="phone_billing_modal" class="mb-2 block text-sm font-medium text-gray-900 dark:text-white">Telefonnummer*</label>
                        <input type="text" id="phone_billing_modal" name="phonenumber"
                            class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-primary-500 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder:text-gray-400 dark:focus:border-primary-500 dark:focus:ring-primary-500"
                            placeholder="Telefonnummer" required />
                    </div>

                    <div>
                        <label for="street_billing_modal" class="mb-2 block text-sm font-medium text-gray-900 dark:text-white">Straße*</label>
                        <input type="text" id="street_billing_modal" name="street"
                            class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-primary-500 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder:text-gray-400 dark:focus:border-primary-500 dark:focus:ring-primary-500"
                            placeholder="Straße" required />
                    </div>

                    <div>
                        <label for="street_number_billing_modal" class="mb-2 block text-sm font-medium text-gray-900 dark:text-white">Hausnummer*</label>
                        <input type="text" id="street_number_billing_modal" name="streetNumber"
                            class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-primary-500 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder:text-gray-400 dark:focus:border-primary-500 dark:focus:ring-primary-500"
                            placeholder="Hausnummer" required />
                    </div>

                    <div>
                        <label for="city_billing_modal" class="mb-2 block text-sm font-medium text-gray-900 dark:text-white">Stadt*</label>
                        <input type="text" id="city_billing_modal" name="city"
                            class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-primary-500 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder:text-gray-400 dark:focus:border-primary-500 dark:focus:ring-primary-500"
                            placeholder="Stadt" required />
                    </div>

                    <div>
                        <label for="postalcode_billing_modal" class="mb-2 block text-sm font-medium text-gray-900 dark:text-white">Postleitzahl*</label>
                        <input type="text" id="postalcode_billing_modal" name="postalcode"
                            class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-primary-500 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder:text-gray-400 dark:focus:border-primary-500 dark:focus:ring-primary-500"
                            placeholder="Postleitzahl" required />
                    </div>

                    <div class="sm:col-span-2">
                        <div class="mb-2 flex items-center gap-2">
                            <label for="select_country_input_billing_modal"
                                class="block text-sm font-medium text-gray-900 dark:text-white">Land*</label>
                        </div>
                        <select id="select_country_input_billing_modal" name="country" class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-primary-500 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder:text-gray-400 dark:focus:border-primary-500 dark:focus:ring-primary-500">
                            {% get_choices "CountryChoices" as countries %}
                            {% for item in countries %}
                            <option value="{{item.0}}" {% if order.country == item.0 %}selected{% endif %}>{{ item.1 }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="sm:col-span-2">
                        <label for="comment_billing_modal"
                            class="mb-2 block text-sm font-medium text-gray-900 dark:text-white">Addresszusatz
                        </label>
                        <textarea id="comment_billing_modal" name="comment" rows="4"
                            class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-primary-500 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder:text-gray-400 dark:focus:border-primary-500 dark:focus:ring-primary-500"
                            placeholder="Enter here your address"></textarea>
                    </div>

                </div>
                <div class="border-t border-gray-200 pt-4 dark:border-gray-700 md:pt-5">
                    <button type="button" onclick="hideModal('billingInformationModal')" class="me-2 rounded-lg border border-gray-200 bg-white px-5 py-2.5 text-sm font-medium text-gray-900 hover:bg-gray-100 hover:text-primary-700 focus:z-10 focus:outline-none focus:ring-4 focus:ring-gray-100 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white dark:focus:ring-gray-700">
                        Abbrechen
                    </button>
                    <button type="button" onclick="saveInvoiceDatas()" class="me-2 inline-flex items-center rounded-lg bg-green-700 px-5 py-2.5 text-center text-sm font-medium text-white hover:bg-green-800 focus:outline-none focus:ring-4 focus:ring-green-300 dark:bg-green-600 dark:hover:bg-green-700 dark:focus:ring-green-800">
                        Speichern
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="deliveryInformationModal" tabindex="-1" aria-hidden="true"
    class="antialiased fixed left-0 right-0 top-0 z-50 hidden h-[calc(100%-1rem)] max-h-full w-full items-center justify-center overflow-y-auto overflow-x-hidden antialiased md:inset-0">
    <div class="relative max-h-full w-full max-w-lg p-4">
        <!-- Modal content -->
        <div class="relative rounded-lg bg-white shadow dark:bg-gray-800">
            <!-- Modal header -->
            <div
                class="flex items-center justify-between rounded-t border-b border-gray-200 p-4 dark:border-gray-700 md:p-5">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Lieferinformationen</h3>
            </div>
            <!-- Modal body -->
            <form class="p-4 md:p-5" id="deliveryForm">
                <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 mb-5">

                    <div class="sm:col-span-2">
                        <label for="first_name_delivery_modal"
                            class="mb-2 block text-sm font-medium text-gray-900 dark:text-white"> Liefermethode* </label>
                        <select id="delivery-methods-modal" name="deliveryType"
                            class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-primary-500 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder:text-gray-400 dark:focus:border-primary-500 dark:focus:ring-primary-500">
                            {% get_choices "DeliveryTypeChoices" as deliveryTypes %}
                            {% for item in deliveryTypes %}
                            <option value="{{item.0}}" {% if order.country == item.0 %}selected{% endif %}>{{ item.1 }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- <div class="flex items-center gap-4 sm:col-span-2">
                        <div class="flex items-center">
                          <input id="delivery_address_as_invoice" aria-expanded="false" type="checkbox" value="" name="deliveryAddressAsInvoice" class="cursor-pointer h-4 w-4 rounded border-gray-300 bg-gray-100 text-primary-600 focus:ring-2 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:ring-offset-gray-800 dark:focus:ring-primary-600" />
                          <label for="delivery_address_as_invoice" class="cursor-pointer ms-2 text-sm font-medium text-gray-900 dark:text-gray-300"> Lieferadresse = Rechnungsadresse </label>
                        </div>
                    </div> -->

                    <div>
                        <label for="first_name_delivery_modal"
                            class="mb-2 block text-sm font-medium text-gray-900 dark:text-white"> Vorname* </label>
                        <input type="text" id="first_name_delivery_modal" name="firstName"
                            class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-primary-500 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder:text-gray-400 dark:focus:border-primary-500 dark:focus:ring-primary-500"
                            placeholder="Vorname" required />
                    </div>

                    <div>
                        <label for="last_name_delivery_modal"
                            class="mb-2 block text-sm font-medium text-gray-900 dark:text-white"> Nachname* </label>
                        <input type="text" id="last_name_delivery_modal" name="lastName"
                            class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-primary-500 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder:text-gray-400 dark:focus:border-primary-500 dark:focus:ring-primary-500"
                            placeholder="Nachname" required />
                    </div>

                    <div>
                        <label for="street_delivery_modal"
                            class="mb-2 block text-sm font-medium text-gray-900 dark:text-white"> Straße* </label>
                        <input type="text" id="street_delivery_modal" name="street"
                            class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-primary-500 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder:text-gray-400 dark:focus:border-primary-500 dark:focus:ring-primary-500"
                            placeholder="Straße" required />
                    </div>

                    <div>
                        <label for="street_number_delivery_modal"
                            class="mb-2 block text-sm font-medium text-gray-900 dark:text-white"> Hausnummer* </label>
                        <input type="text" id="street_number_delivery_modal" name="streetNumber"
                            class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-primary-500 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder:text-gray-400 dark:focus:border-primary-500 dark:focus:ring-primary-500"
                            placeholder="Hausnummer" required />
                    </div>

                    <div>
                        <label for="postalcode_delivery_modal"
                            class="mb-2 block text-sm font-medium text-gray-900 dark:text-white"> Postleitzahl* </label>
                        <input type="text" id="postalcode_delivery_modal" name="postalcode"
                            class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-primary-500 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder:text-gray-400 dark:focus:border-primary-500 dark:focus:ring-primary-500"
                            placeholder="Postleitzahl" required />
                    </div>

                    <div>
                        <label for="city_delivery_modal"
                            class="mb-2 block text-sm font-medium text-gray-900 dark:text-white"> Stadt* </label>
                        <input type="text" id="city_delivery_modal" name="city"
                            class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-primary-500 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder:text-gray-400 dark:focus:border-primary-500 dark:focus:ring-primary-500"
                            placeholder="Stadt" required />
                    </div>

                    <div class="sm:col-span-2">
                        <div class="mb-2 flex items-center gap-2">
                            <label for="select_country_input_delivery_modal"
                                class="block text-sm font-medium text-gray-900 dark:text-white"> Country* </label>
                        </div>
                        <select id="select_country_input_delivery_modal" name="country"
                            class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-primary-500 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder:text-gray-400 dark:focus:border-primary-500 dark:focus:ring-primary-500">
                            {% get_choices "CountryChoices" as countries %}
                            {% for item in countries %}
                            <option value="{{item.0}}" {% if order.country == item.0 %}selected{% endif %}>{{ item.1 }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="sm:col-span-2">
                        <label for="comment_delivery_modal"
                            class="mb-2 block text-sm font-medium text-gray-900 dark:text-white"> Kommentar
                        </label>
                        <textarea id="comment_delivery_modal" name="comment" rows="4"
                            class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm text-gray-900 focus:border-primary-500 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder:text-gray-400 dark:focus:border-primary-500 dark:focus:ring-primary-500"
                            placeholder="Kommentar"></textarea>
                    </div>

                </div>
                <div class="border-t border-gray-200 pt-4 dark:border-gray-700 md:pt-5">
                    <button type="button" onclick="hideModal('deliveryInformationModal')" class="me-2 rounded-lg border border-gray-200 bg-white px-5 py-2.5 text-sm font-medium text-gray-900 hover:bg-gray-100 hover:text-primary-700 focus:z-10 focus:outline-none focus:ring-4 focus:ring-gray-100 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white dark:focus:ring-gray-700">
                        Abbrechen
                    </button>
                    <button type="button" onclick="saveDeliveryDatas()" class="me-2 inline-flex items-center rounded-lg bg-green-700 px-5 py-2.5 text-center text-sm font-medium text-white hover:bg-green-800 focus:outline-none focus:ring-4 focus:ring-green-300 dark:bg-green-600 dark:hover:bg-green-700 dark:focus:ring-green-800">
                        Speichern
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="paymentInformationModal" tabindex="-1" aria-hidden="true"
    class="antialiased fixed left-0 right-0 top-0 z-50 hidden h-[calc(100%-1rem)] max-h-full w-full items-center justify-center overflow-y-auto overflow-x-hidden antialiased md:inset-0">
    <div class="relative max-h-full w-full max-w-lg p-4">
        <!-- Modal content -->
        <div class="relative rounded-lg bg-white shadow dark:bg-gray-800">
            <!-- Modal header -->
            <div
                class="flex items-center justify-between rounded-t border-b border-gray-200 p-4 dark:border-gray-700 md:p-5">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Zahlungsmethode</h3>
            </div>
            <!-- Modal body -->
            <form class="p-4 md:p-5" id="paymentForm">
                <div class="mb-5">
                    <div class="space-y-4">
                        {% get_choices "PaymentTypeChoices" as PaymentTypeChoices %}
                        {% for item in PaymentTypeChoices %}
                        <div id="divPaymentMethod-{{ item.0 }}" class="flex items-center justify-between rounded-lg border border-gray-200 bg-gray-50 p-4 ps-4 dark:border-gray-600 dark:bg-gray-700">
                            <div>
                                <div class="flex items-start">
                                    <div class="flex h-5 items-center">
                                        <input id="paymentType-{{ item.0 }}" aria-describedby="visa-text" type="radio" name="payment_type"
                                            value="{{ item.0 }}"
                                            class="cursor-pointer h-4 w-4 border-gray-300 bg-white text-primary-600 focus:ring-2 focus:ring-primary-500 dark:border-gray-500 dark:bg-gray-600 dark:ring-offset-gray-800 dark:focus:ring-primary-600"
                                            checked />
                                    </div>

                                    <div class="ms-4 text-sm">
                                        <label for="paymentType-{{ item.0 }}" class="cursor-pointer font-medium text-gray-900 dark:text-white">
                                            {{ item.1 }}
                                        </label>
                                        {% if item.0 == "payment_at_pickup" %}
                                        <p id="mastercard-text" class="text-xs font-normal text-gray-500 dark:text-gray-400">Nur bei Liefermethode <strong>Abholung</strong> möglich</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- <div class="shrink-0">
                                <img class="h-8 w-auto dark:hidden"
                                    src="https://flowbite.s3.amazonaws.com/blocks/e-commerce/brand-logos/visa.svg"
                                    alt="" />
                                <img class="hidden h-8 w-auto dark:flex"
                                    src="https://flowbite.s3.amazonaws.com/blocks/e-commerce/brand-logos/visa-dark.svg"
                                    alt="" />
                            </div> -->
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="border-t border-gray-200 pt-4 dark:border-gray-700 md:pt-5">
                    <button type="button" onclick="hideModal('paymentInformationModal')" class="me-2 rounded-lg border border-gray-200 bg-white px-5 py-2.5 text-sm font-medium text-gray-900 hover:bg-gray-100 hover:text-primary-700 focus:z-10 focus:outline-none focus:ring-4 focus:ring-gray-100 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white dark:focus:ring-gray-700">
                        Abbrechen
                    </button>
                    <button type="button" onclick="savePaymentMethod()" class="me-2 inline-flex items-center rounded-lg bg-green-700 px-5 py-2.5 text-center text-sm font-medium text-white hover:bg-green-800 focus:outline-none focus:ring-4 focus:ring-green-300 dark:bg-green-600 dark:hover:bg-green-700 dark:focus:ring-green-800">
                        Speichern
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="successOrderModal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-modal md:h-full">
    <div class="relative p-4 w-full max-w-md h-full md:h-auto">
        <!-- Modal content -->
        <div class="relative p-4 text-center bg-white rounded-lg shadow dark:bg-gray-800 sm:p-5">
            <div class="w-12 h-12 rounded-full bg-green-100 dark:bg-green-900 p-2 flex items-center justify-center mx-auto mb-3.5">
                <svg aria-hidden="true" class="w-8 h-8 text-green-500 dark:text-green-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                <span class="sr-only">Success</span>
            </div>
            <p class="mb-4 text-lg font-semibold text-gray-900 dark:text-white">Vielen Dank!</p>
            <p class="mb-4 text-lg font-semibold text-gray-900 dark:text-white">Deine Bestellung wurde erfoglreich bestätigt.</p>
        </div>
    </div>
</div>

<div id="orderedOrderModal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-modal md:h-full">
    <div class="relative p-4 w-full max-w-md h-full md:h-auto">
        <!-- Modal content -->
        <div class="relative p-4 text-center bg-white rounded-lg shadow dark:bg-gray-800 sm:p-5">
            <div class="w-12 h-12 rounded-full bg-green-100 dark:bg-green-900 p-2 flex items-center justify-center mx-auto mb-3.5">
                <svg aria-hidden="true" class="w-8 h-8 text-green-500 dark:text-green-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                <span class="sr-only">Success</span>
            </div>
            <p class="mb-4 text-lg font-semibold text-gray-900 dark:text-white">Diese Bestellung wurde bereits bestätigt.</p>
        </div>
    </div>
</div>

<div id="deleteOrderModal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-modal md:h-full">
    <div class="relative p-4 w-full max-w-md h-full md:h-auto">
        <!-- Modal content -->
        <div class="relative p-4 text-center bg-white rounded-lg shadow dark:bg-gray-800 sm:p-5">
            <svg class="text-gray-400 dark:text-gray-500 w-11 h-11 mb-3.5 mx-auto" aria-hidden="true" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
            <p class="mb-4 text-gray-500 dark:text-gray-300">Möchten Sie die Bestellung sicher ablehnen?</p>
            <div class="flex justify-center items-center space-x-4">
                <button onclick="hideModal('deleteOrderModal')" type="button" class="py-2 px-3 text-sm font-medium text-gray-500 bg-white rounded-lg border border-gray-200 hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-primary-300 hover:text-gray-900 focus:z-10 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-500 dark:hover:text-white dark:hover:bg-gray-600 dark:focus:ring-gray-600">
                    Abbrechen
                </button>
                <button onclick="deleteOrder()" type="button" class="py-2 px-3 text-sm font-medium text-center text-white bg-red-600 rounded-lg hover:bg-red-700 focus:ring-4 focus:outline-none focus:ring-red-300 dark:bg-red-500 dark:hover:bg-red-600 dark:focus:ring-red-900">
                    Ich bin sicher
                </button>
            </div>
        </div>
    </div>
</div>


<div id="orderCancelledModal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-modal md:h-full">
    <div class="relative p-4 w-full max-w-md h-full md:h-auto">
        <!-- Modal content -->
        <div class="relative p-4 text-center bg-white rounded-lg shadow dark:bg-gray-800 sm:p-5">
            <div class="w-12 h-12 rounded-full bg-red-100 dark:bg-red-900 p-2 flex items-center justify-center mx-auto mb-3.5">
                <svg class="w-8 h-8 text-red-500 dark:text-red-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m15 9-6 6m0-6 6 6m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
                </svg>
            </div>              
            <p class="mb-4 text-lg font-semibold text-gray-900 dark:text-white">Diese Bestellung wurde bereits storniert.</p>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
<script data-orderid="{{ order.id }}" data-ordered="{{ order.ordered }}" data-status="{{ order.status }}">

    // Invoices
    const firstName = $('[name=firstName]', '#invoiceForm');
    const lastName = $('[name=lastName]', '#invoiceForm');
    const email = $('[name=email]', '#invoiceForm');
    const phonenumber = $('[name=phonenumber]', '#invoiceForm');
    const street = $('[name=street]', '#invoiceForm');
    const streetNumber = $('[name=streetNumber]', '#invoiceForm');
    const postalcode = $('[name=postalcode]', '#invoiceForm');
    const city = $('[name=city]', '#invoiceForm');
    const country = $('[name=country]', '#invoiceForm');
    const comment = $('[name=comment]', '#invoiceForm');

    // Delivery
    const deliveryFirstName = $('[name=firstName]', '#deliveryForm');
    const deliveryLastName = $('[name=lastName]', '#deliveryForm');
    const deliveryStreet = $('[name=street]', '#deliveryForm');
    const deliveryStreetNumber = $('[name=streetNumber]', '#deliveryForm');
    const deliveryPostalcode = $('[name=postalcode]', '#deliveryForm');
    const deliveryCity = $('[name=city]', '#deliveryForm');
    const deliveryCountry = $('[name=country]', '#deliveryForm');
    const deliveryComment = $('[name=comment]', '#deliveryForm');
    const deliveryType = $('[name=deliveryType]', '#deliveryForm');

    const regexEmail = /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,8})+$/

    var dataFields = new FormData()

    const orderDatas = document.currentScript.dataset

    const openBillingInformationModal = () => {

        $.ajax({
            type: 'POST',
            url: '{% url "request_user_order_functions" %}',
            traditional: true,
            data: {
                'getOrderDetails': 'getOrderDetails',
                'orderId': orderDatas.orderid,
            },
            success: (data) => {

                const orderDetails = data.orderDetails

                firstName.val(orderDetails.firstName)
                lastName.val(orderDetails.lastName)
                email.val(orderDetails.email)
                phonenumber.val(orderDetails.phonenumber)
                street.val(orderDetails.street)
                streetNumber.val(orderDetails.streetNumber)
                postalcode.val(orderDetails.postalcode)
                city.val(orderDetails.city)
                country.val(orderDetails.country)
                comment.val(orderDetails.comment)

                toggleModal('billingInformationModal', { backdrop: 'static' })
            },
            error: () => {
                showToast('wrongToast', 'Fehler beim Laden der Rechnungsdaten.')
            }
        })

    }

    const validateInoviceDatas = () => {

        // Bestelldaten
        const firstNameValue = firstName.val()
        const lastNameValue = lastName.val()
        const streetValue = street.val()
        const streetNumberValue = streetNumber.val()
        const postalcodeValue = postalcode.val()
        const cityValue = city.val()
        const countryValue = country.val()
        const phonenumberValue = phonenumber.val()
        const emailValue = email.val()
        const commentValue = comment.val()

        const validationFields = [
            'firstName',
            'lastName',
            'street',
            'streetNumber',
            'postalcode',
            'city',
            'country',
            'phonenumber',
            'email',
        ]

        const formData = {
            firstName: firstNameValue,
            lastName: lastNameValue,
            street: streetValue,
            streetNumber: streetNumberValue,
            postalcode: postalcodeValue,
            city: cityValue,
            country: countryValue,
            phonenumber: phonenumberValue,
            email: emailValue,
            comment: commentValue,
        }

        const formDataFields = {
            firstName: firstName,
            lastName: lastName,
            street: street,
            streetNumber: streetNumber,
            postalcode: postalcode,
            city: city,
            country: country,
            phonenumber: phonenumber,
            email: email,
        }

        let wrongFields = []

        // Validate all fields (defined in validationFields) for content
        const validate = (obj, fields) => {

            for (let field of fields) {
                if (!Array.isArray(field)) {
                    if (field === 'email' || field === 'mail') {
                        if (obj?.[field] === undefined || obj?.[field] === '' || !regexEmail.test(obj?.[field])) wrongFields.push(field); 
                    }
                    if (obj?.[field] === undefined || obj?.[field] === '') wrongFields.push(field);
                } else if (!obj?.[field[0]] || !checkField(obj[field[0]], field[1])) return false;
            }
            
            if (wrongFields.length != 0) {
                for (let field of wrongFields) {
                    $(formDataFields?.[field]).addClass('input-error')
                }
                // focus first wrong field
                $(formDataFields?.[wrongFields[0]])[0].focus()
                return false;
            }

            invoiceData = formData
            
            dataFields.append('invoiceData', JSON.stringify(invoiceData))
            
            return true;

        };
        return validate(formData, validationFields)
        
    }

    const saveInvoiceDatas = () => {

        dataFields = new FormData()

        dataFields.append('saveInvoiceDatas', 'saveInvoiceDatas')
        dataFields.append('orderId', orderDatas.orderid)

        if (validateInoviceDatas()) {
            $.ajax({
                type: 'POST',
                url: '{% url "request_user_order_functions" %}',
                processData: false,  // Wichtig: Verhindert, dass jQuery die Daten verarbeitet
                contentType: false,
                traditional: true,
                data: dataFields,
                success: (data) => {

                    $('.first_name').html(firstName.val())
                    $('.last_name').html(lastName.val())
                    $('.street').html(street.val())
                    $('.street_number').html(streetNumber.val())
                    $('.postalcode').html(postalcode.val())
                    $('.city').html(city.val())
                    $('.phone_number').html(phonenumber.val())
                    $('.email_address').html(email.val())

                    hideModal('billingInformationModal')
                    showToast('successToast', 'Rechnungsdaten wurden erfolgreich gespeichert.')
                },
                error: () => {
                    // toggleModal('alert-modal')
                }
            })
        }

    }

    const openDeliveryInformationModal = () => {

        $.ajax({
            type: 'POST',
            url: '{% url "request_user_order_functions" %}',
            traditional: true,
            data: {
                'getOrderDetails': 'getOrderDetails',
                'orderId': orderDatas.orderid,
            },
            success: (data) => {

                const orderDetails = data.orderDetails

                deliveryFirstName.val(orderDetails.delFirstName)
                deliveryLastName.val(orderDetails.delLastName)
                deliveryStreet.val(orderDetails.delStreet)
                deliveryStreetNumber.val(orderDetails.delStreetNumber)
                deliveryPostalcode.val(orderDetails.delPostalcode)
                deliveryCity.val(orderDetails.delCity)
                deliveryCountry.val(orderDetails.delCountry)
                deliveryComment.val(orderDetails.delComment)
                deliveryType.val(orderDetails.deliveryType)

                toggleModal('deliveryInformationModal', { backdrop: 'static' })
            },
            error: () => {
                // toggleModal('alert-modal')
            }
        })

    }

    $('#delivery_address_as_invoice').on('change', function() {
        if ($(this).is(':checked')) {
            // Disable fields
            deliveryFirstName.prop('disabled', true)
            deliveryLastName.prop('disabled', true)
            deliveryStreet.prop('disabled', true)
            deliveryStreetNumber.prop('disabled', true)
            deliveryPostalcode.prop('disabled', true)
            deliveryCity.prop('disabled', true)
            deliveryCountry.prop('disabled', true)
        } else {
            // Enable fields
            deliveryFirstName.prop('disabled', false)
            deliveryLastName.prop('disabled', false)
            deliveryStreet.prop('disabled', false)
            deliveryStreetNumber.prop('disabled', false)
            deliveryPostalcode.prop('disabled', false)
            deliveryCity.prop('disabled', false)
            deliveryCountry.prop('disabled', false)
        }
    })

    const validateDeliveryDatas = () => {

        // Bestelldaten
        const firstNameValue = deliveryFirstName.val()
        const lastNameValue = deliveryLastName.val()
        const streetValue = deliveryStreet.val()
        const streetNumberValue = deliveryStreetNumber.val()
        const postalcodeValue = deliveryPostalcode.val()
        const cityValue = deliveryCity.val()
        const countryValue = deliveryCountry.val()
        const commentValue = deliveryComment.val()
        const deliveryTypeValue = deliveryType.val()

        const validationFields = [
            'firstName',
            'lastName',
            'street',
            'streetNumber',
            'postalcode',
            'city',
            'country',
            'deliveryType',
        ]

        const formData = {
            firstName: firstNameValue,
            lastName: lastNameValue,
            street: streetValue,
            streetNumber: streetNumberValue,
            postalcode: postalcodeValue,
            city: cityValue,
            country: countryValue,
            deliveryType: deliveryTypeValue,
            comment: commentValue,
        }

        const formDataFields = {
            firstName: deliveryFirstName,
            lastName: deliveryLastName,
            street: deliveryStreet,
            streetNumber: deliveryStreetNumber,
            postalcode: deliveryPostalcode,
            city: deliveryCity,
            country: deliveryCountry,
            deliveryType: deliveryType,
        }

        let wrongFields = []

        // Validate all fields (defined in validationFields) for content
        const validate = (obj, fields) => {

            for (let field of fields) {
                if (!Array.isArray(field)) {
                    if (field === 'email' || field === 'mail') {
                        if (obj?.[field] === undefined || obj?.[field] === '' || !regexEmail.test(obj?.[field])) wrongFields.push(field); 
                    }
                    if (obj?.[field] === undefined || obj?.[field] === '') wrongFields.push(field);
                } else if (!obj?.[field[0]] || !checkField(obj[field[0]], field[1])) return false;
            }
            
            if (wrongFields.length != 0) {
                for (let field of wrongFields) {
                    $(formDataFields?.[field]).addClass('input-error')
                }
                // focus first wrong field
                $(formDataFields?.[wrongFields[0]])[0].focus()
                return false;
            }

            deliveryData = formData
            
            dataFields.append('deliveryData', JSON.stringify(deliveryData))
            
            return true;

        };
        return validate(formData, validationFields)
    }

    const saveDeliveryDatas = () => {

        dataFields.append('saveDeliveryDatas', 'saveDeliveryDatas')
        dataFields.append('orderId', orderDatas.orderid)

        if (validateDeliveryDatas()) {
            $.ajax({
                type: 'POST',
                url: '{% url "request_user_order_functions" %}',
                processData: false,  // Wichtig: Verhindert, dass jQuery die Daten verarbeitet
                contentType: false,
                traditional: true,
                data: dataFields,
                success: (data) => {

                    $('.delivery_first_name').html(deliveryFirstName.val())
                    $('.delivery_last_name').html(deliveryLastName.val())
                    $('.delivery_street').html(deliveryStreet.val())
                    $('.delivery_street_number').html(deliveryStreetNumber.val())
                    $('.delivery_postalcode').html(deliveryPostalcode.val())
                    $('.delivery_city').html(deliveryCity.val())
                    $('.delivery_country').html(deliveryCountry.val())
                    $('.delivery_type').html(data.deliveryType)
                    $('.delivery_comment').html(deliveryComment.val())
                    $('.payment_type').html(data.paymentType)

                    hideModal('deliveryInformationModal')
                    showToast('successToast', 'Lieferdaten wurden erfolgreich gespeichert.')
                },
                error: () => {
                    showToast(errorToast, 'Ein Fehler ist aufgetreten.')
                }
            })
        }

    }

    const openPaymentInformationModal = () => {

        $.ajax({
            type: 'POST',
            url: '{% url "request_user_order_functions" %}',
            traditional: true,
            data: {
                'getOrderDetails': 'getOrderDetails',
                'orderId': orderDatas.orderid,
            },
            success: (data) => {

                const orderDetails = data.orderDetails
                
                if (orderDetails.deliveryType != 'pickup') {
                    $('#paymentType-payment_at_pickup').prop('disabled', true)
                    $('#divPaymentMethod-payment_at_pickup').addClass('opacity-50')
                    $('#divPaymentMethod-payment_at_pickup').addClass('cursor-not-allowed')
                    $('#divPaymentMethod-payment_at_pickup label').removeClass('cursor-pointer')
                    $('#divPaymentMethod-payment_at_pickup label').addClass('cursor-not-allowed')
                } else {
                    $('#paymentType-payment_at_pickup').prop('disabled', false)
                    $('#divPaymentMethod-payment_at_pickup').removeClass('opacity-50')
                    $('#divPaymentMethod-payment_at_pickup').removeClass('cursor-not-allowed')
                    $('#divPaymentMethod-payment_at_pickup label').addClass('cursor-pointer')
                    $('#divPaymentMethod-payment_at_pickup label').removeClass('cursor-not-allowed')
                }

                // Check payment method
                $(`#paymentType-${orderDetails.paymentType}`).prop('checked', true)

                toggleModal('paymentInformationModal', { backdrop: 'static' })
            },
            error: () => {
                // toggleModal('alert-modal')
            }
        })

    }

    const savePaymentMethod = () => {

        // Payment
        const paymentType = $('[name=payment_type]:checked', '#paymentForm');

        dataFields.append('savePaymentMethod', 'savePaymentMethod')
        dataFields.append('orderId', orderDatas.orderid)
        dataFields.append('paymentType', paymentType.val())

        $.ajax({
            type: 'POST',
            url: '{% url "request_user_order_functions" %}',
            processData: false,  // Wichtig: Verhindert, dass jQuery die Daten verarbeitet
            contentType: false,
            traditional: true,
            data: dataFields,
            success: (data) => {

                $('.payment_type').html(data.paymentType)

                hideModal('paymentInformationModal')
                showToast('successToast', 'Zahlungsmethode wurde erfolgreich gespeichert.')
            },
            error: () => {
                // toggleModal('alert-modal')
            }
        })

    }

    const saveOrder = () => {
        
        $('#terms-checkbox-alert').addClass('hidden')

        // Check if terms-checkbox is not checked
        if (!$('#terms-checkbox').is(':checked')) {
            $('#terms-checkbox-alert').removeClass('hidden')
            return
        }

        $.ajax({
            type: 'POST',
            url: '{% url "request_user_order_functions" %}',
            traditional: true,
            data: {
                'saveOrder': 'saveOrder',
                'orderId': orderDatas.orderid,
            },
            success: (data) => {
                toggleModal('successOrderModal', { backdrop: 'static' })
            },
            error: () => {
                // toggleModal('alert-modal')
            }
        })

    }

    if (orderDatas.ordered == 'True' && orderDatas.status != 'acceptance_refused') {
        toggleModal('orderedOrderModal', { backdrop: 'static' })
    }

    const deleteOrder = () => {

        $.ajax({
            type: 'POST',
            url: '{% url "request_user_order_functions" %}',
            traditional: true,
            data: {
                'deleteOrder': 'deleteOrder',
                'orderId': orderDatas.orderid,
            },
            success: (data) => {
                toggleModal('deleteOrderModal')
            },
            error: () => {
                // toggleModal('alert-modal')
            }
        })
    }

    if (orderDatas.status == 'acceptance_refused') {
        toggleModal('orderCancelledModal', { backdrop: 'static' })
    }

</script>
{% endblock %}
